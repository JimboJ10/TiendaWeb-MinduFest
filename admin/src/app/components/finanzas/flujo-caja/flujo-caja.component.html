<app-sidebar></app-sidebar>

<!-- Page title-->
<div class="border-bottom pt-5 mt-2 mb-5">
    <h1 class="mt-2 mt-md-4 mb-3 pt-5">Flujo de Caja</h1>
    <div class="d-flex flex-wrap flex-md-nowrap justify-content-between">
        <p class="text-muted">Movimientos de ingresos y egresos</p>
        <div class="d-flex gap-2">
            <button class="btn btn-success" (click)="nuevo_movimiento()">
                <i class="fa fa-plus"></i> Nuevo Movimiento
            </button>
            <button class="btn btn-secondary" (click)="regresar()">
                <i class="fa fa-arrow-left"></i> Regresar
            </button>
        </div>
    </div>
</div>

<!-- Resumen -->
<div class="row mb-4" *ngIf="resumen">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fa fa-arrow-up fa-2x mb-2"></i>
                <h4>{{formatear_moneda(resumen.resumen.total_ingresos)}}</h4>
                <p class="mb-0">Total Ingresos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <i class="fa fa-arrow-down fa-2x mb-2"></i>
                <h4>{{formatear_moneda(resumen.resumen.total_egresos)}}</h4>
                <p class="mb-0">Total Egresos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card" [class]="resumen.resumen.saldo_neto >= 0 ? 'bg-primary' : 'bg-warning'">
            <div class="card-body text-center text-white">
                <i class="fa fa-balance-scale fa-2x mb-2"></i>
                <h4>{{formatear_moneda(resumen.resumen.saldo_neto)}}</h4>
                <p class="mb-0">Saldo Neto</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fa fa-list fa-2x mb-2"></i>
                <h4>{{resumen.resumen.total_movimientos}}</h4>
                <p class="mb-0">Total Movimientos</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card box-shadow-sm mb-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fa fa-filter"></i> Filtros
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label>Fecha Desde:</label>
                <input type="date" 
                       class="form-control" 
                       [(ngModel)]="fecha_desde">
            </div>
            <div class="col-md-3">
                <label>Fecha Hasta:</label>
                <input type="date" 
                       class="form-control" 
                       [(ngModel)]="fecha_hasta">
            </div>
            <div class="col-md-2">
                <label>Tipo:</label>
                <select class="form-control" [(ngModel)]="tipo_filtro">
                    <option value="">Todos</option>
                    <option *ngFor="let tipo of tipos" [value]="tipo">{{tipo}}</option>
                </select>
            </div>
            <div class="col-md-2">
                <label>Categoría:</label>
                <select class="form-control" [(ngModel)]="categoria_filtro">
                    <option value="">Todas</option>
                    <option *ngFor="let categoria of categorias" [value]="categoria">{{categoria}}</option>
                </select>
            </div>
            <div class="col-md-2">
                <label>&nbsp;</label>
                <div class="d-flex gap-2">
                    <button type="button" 
                            class="btn btn-primary btn-block" 
                            (click)="aplicar_filtros()">
                        <i class="fa fa-search"></i> Buscar
                    </button>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <button type="button" 
                        class="btn btn-secondary btn-sm" 
                        (click)="limpiar_filtros()">
                    <i class="fa fa-times"></i> Limpiar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lista de movimientos -->
<div class="card box-shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="fa fa-list"></i> 
            Movimientos de Caja ({{movimientos.length}})
        </h6>
    </div>

    <div class="table-responsive" *ngIf="movimientos.length > 0 && !load_data">
        <table class="table table-hover">
            <thead class="thead-light">
                <tr>
                    <th>Fecha</th>
                    <th>Concepto</th>
                    <th>Tipo</th>
                    <th>Categoría</th>
                    <th>Monto</th>
                    <th>Método</th>
                    <th>Referencia</th>
                    <th>Usuario</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let movimiento of movimientos | slice: (page-1) * pageSize : page * pageSize">
                    <td>
                        <small>{{formatear_fecha(movimiento.fecha)}}</small>
                    </td>
                    <td>
                        <strong>{{movimiento.concepto}}</strong>
                        <div *ngIf="movimiento.observaciones" class="small text-muted">
                            {{movimiento.observaciones}}
                        </div>
                    </td>
                    <td>
                        <span class="badge" [class]="'badge ' + get_badge_tipo(movimiento.tipo)">
                            {{movimiento.tipo}}
                        </span>
                    </td>
                    <td>
                        <span class="badge" [class]="'badge ' + get_badge_categoria(movimiento.categoria)">
                            {{movimiento.categoria}}
                        </span>
                    </td>
                    <td>
                        <span class="font-weight-bold" 
                              [class]="movimiento.tipo === 'Ingreso' ? 'text-success' : 'text-danger'">
                            {{formatear_moneda(movimiento.monto)}}
                        </span>
                    </td>
                    <td>
                        <small>{{movimiento.metodo_pago || 'N/A'}}</small>
                    </td>
                    <td>
                        <small>{{movimiento.referencia_documento || 'N/A'}}</small>
                    </td>
                    <td>
                        <small>{{movimiento.usuario_nombres}} {{movimiento.usuario_apellidos}}</small>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Loading -->
    <div *ngIf="load_data" class="card-body text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando movimientos...</p>
    </div>

    <!-- No hay datos -->
    <div class="card-body text-center" *ngIf="movimientos.length === 0 && !load_data">
        <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No hay movimientos registrados</h5>
        <p class="text-muted">Registre el primer movimiento de caja</p>
        <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-primary" (click)="nuevo_movimiento()">
                <i class="fa fa-plus"></i> Nuevo Movimiento
            </button>
            <button class="btn btn-secondary" (click)="regresar()">
                <i class="fa fa-arrow-left"></i> Regresar
            </button>
        </div>
    </div>
</div>

<!-- Paginación -->
<nav *ngIf="!load_data && movimientos.length > pageSize" class="mt-4">
    <ngb-pagination 
        [(page)]="page" 
        [pageSize]="pageSize" 
        [collectionSize]="movimientos.length"
        [maxSize]="5"
        [rotate]="true"
        [boundaryLinks]="true">
    </ngb-pagination>
</nav>