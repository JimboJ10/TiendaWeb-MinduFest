<app-sidebar></app-sidebar>

<!-- Page title-->
<div class="border-bottom pt-5 mt-2 mb-5">
    <h1 class="mt-2 mt-md-4 mb-3 pt-5">
        <i class="fa fa-sitemap text-primary"></i> Plan de Cuentas
    </h1>
    <div class="d-flex flex-wrap flex-md-nowrap justify-content-between">
      <p class="text-muted">Cat√°logo completo de cuentas contables organizadas por categor√≠as</p>
      <p class="font-size-sm font-weight-medium pl-md-4">
        <a class="text-nowrap" [routerLink]="['/panel/finanzas']">
            <i class="fa fa-arrow-left"></i> Regresar a Finanzas
        </a>
      </p>
    </div>
</div>

<!-- Resumen por tipos de cuenta -->
<div class="row mb-4" *ngIf="!load_data">
    <div class="col" *ngFor="let tipo of tipos_cuenta">
        <div class="card text-center" [ngClass]="getCardColorTipo(tipo)">
            <div class="card-body py-3">
                <i [ngClass]="getIconoTipo(tipo)" class="fa-2x mb-2"></i>
                <h6 class="text-white">{{ tipo }}s</h6>
                <h4 class="text-white mb-0">{{ getContadorTipo(tipo) }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Filtros mejorados -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fa fa-filter text-primary"></i> Filtros de B√∫squeda
        </h5>
        <div>
            <button class="btn btn-success btn-sm" (click)="crear_cuenta()">
                <i class="fa fa-plus"></i> Nueva Cuenta
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-lg-3">
                <label class="form-label text-primary">
                    <i class="fa fa-search"></i> Buscar cuenta
                </label>
                <div class="input-group">
                    <input type="text" class="form-control" 
                           placeholder="C√≥digo o nombre..." 
                           [(ngModel)]="filtro" 
                           (keyup.enter)="filtrar()">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" (click)="filtrar()">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-lg-2">
                <label class="form-label text-primary">
                    <i class="fa fa-tag"></i> Tipo de cuenta
                </label>
                <select class="form-control" [(ngModel)]="tipo_filtro">
                    <option value="">üè∑Ô∏è Todos los tipos</option>
                    <option value="Activo">üí∞ Activos</option>
                    <option value="Pasivo">üí≥ Pasivos</option>
                    <option value="Patrimonio">üë§ Patrimonio</option>
                    <option value="Ingreso">üìà Ingresos</option>
                    <option value="Gasto">üìâ Gastos</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label class="form-label text-primary">
                    <i class="fa fa-layer-group"></i> Nivel
                </label>
                <select class="form-control" [(ngModel)]="nivel_filtro">
                    <option value="">üìä Todos los niveles</option>
                    <option value="1">üîπ Nivel 1 (Principal)</option>
                    <option value="2">üî∏ Nivel 2 (Grupo)</option>
                    <option value="3">üî∫ Nivel 3 (Cuenta)</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label class="form-label text-primary">
                    <i class="fa fa-toggle-on"></i> Estado
                </label>
                <select class="form-control" [(ngModel)]="estado_filtro">
                    <option value="">üîÑ Todos</option>
                    <option value="Activo">‚úÖ Activo</option>
                    <option value="Inactivo">‚ùå Inactivo</option>
                </select>
            </div>
            <div class="col-lg-3">
                <div class="btn-group w-100">
                    <button class="btn btn-primary" (click)="filtrar()">
                        <i class="fa fa-search"></i> Filtrar
                    </button>
                    <button class="btn btn-outline-secondary" (click)="resetear()">
                        <i class="fa fa-refresh"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de cuentas -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fa fa-list"></i> Cuentas Contables
        </h5>
        <span class="badge badge-light">{{ cuentas.length }} cuentas</span>
    </div>
    <div class="card-body p-0">
        <div *ngIf="load_data" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando plan de cuentas...</p>
        </div>

        <!-- Vista no hay cuentas -->
        <div *ngIf="!load_data && cuentas.length === 0" class="text-center py-5">
            <i class="fa fa-sitemap fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No se encontraron cuentas</h5>
            <p class="text-muted">Prueba modificando los filtros o crea una nueva cuenta</p>
            <button class="btn btn-primary" (click)="crear_cuenta()">
                <i class="fa fa-plus"></i> Crear Primera Cuenta
            </button>
        </div>

        <!-- Tabla de cuentas -->
        <div *ngIf="!load_data && cuentas.length > 0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0" style="width: 15%;">
                                <i class="fa fa-hashtag text-primary"></i> C√≥digo
                            </th>
                            <th class="border-0" style="width: 35%;">
                                <i class="fa fa-tag text-primary"></i> Cuenta
                            </th>
                            <th class="border-0" style="width: 20%;">
                                <i class="fa fa-folder text-primary"></i> Clasificaci√≥n
                            </th>
                            <th class="border-0" style="width: 20%;">
                                <i class="fa fa-layer-group text-primary"></i> Jerarqu√≠a
                            </th>
                            <th class="border-0" style="width: 10%;">
                                <i class="fa fa-cogs text-primary"></i> Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let cuenta of cuentas | slice: (page-1) * pageSize : page * pageSize; trackBy: trackByCuenta"
                            class="border-bottom">
                            <td class="align-middle">
                                <div class="d-flex align-items-center">
                                    <div class="level-indicator" [style.background-color]="getColorNivel(cuenta.nivel)"></div>
                                    <code class="bg-light px-2 py-1 rounded ml-2">{{ cuenta.codigo }}</code>
                                </div>
                            </td>
                            <td class="align-middle">
                                <div class="d-flex align-items-center">
                                    <i [ngClass]="getIconoTipo(cuenta.tipo)" [ngClass]="getColorTipoCuenta(cuenta.tipo)" class="mr-2"></i>
                                    <div>
                                        <strong>{{ cuenta.nombre }}</strong>
                                        <br>
                                        <small class="text-muted" *ngIf="cuenta.descripcion">
                                            {{ cuenta.descripcion }}
                                        </small>
                                    </div>
                                </div>
                            </td>
                            <td class="align-middle">
                                <span class="badge badge-pill" [ngClass]="getBadgeTipo(cuenta.tipo)">
                                    {{ cuenta.tipo }}
                                </span>
                                <br>
                                <small class="text-muted" *ngIf="cuenta.subtipo">
                                    {{ cuenta.subtipo }}
                                </small>
                            </td>
                            <td class="align-middle">
                                <div class="d-flex flex-column">
                                    <span class="badge badge-info badge-sm mb-1">
                                        <i class="fa fa-layer-group"></i> Nivel {{ cuenta.nivel }}
                                    </span>
                                    <small class="text-muted" *ngIf="cuenta.cuenta_padre_nombre; else sinPadre">
                                        <i class="fa fa-arrow-up"></i> {{ cuenta.cuenta_padre_nombre }}
                                    </small>
                                    <ng-template #sinPadre>
                                        <small class="text-primary">
                                            <i class="fa fa-crown"></i> Cuenta principal
                                        </small>
                                    </ng-template>
                                </div>
                            </td>
                            <td class="align-middle text-center">
                                <button class="btn btn-outline-warning btn-sm" 
                                        (click)="editar_cuenta(cuenta.cuentaid)"
                                        title="Editar cuenta">
                                    <i class="fa fa-edit"></i> Editar
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Paginaci√≥n -->
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">
                            <i class="fa fa-info-circle"></i>
                            Mostrando {{ (page-1) * pageSize + 1 }} a {{ Math.min(page * pageSize, cuentas.length) }} 
                            de {{ cuentas.length }} cuentas
                        </small>
                    </div>
                    <div>
                        <ngb-pagination
                            [(page)]="page"
                            [pageSize]="pageSize"
                            [collectionSize]="cuentas.length"
                            [maxSize]="5"
                            [boundaryLinks]="true"
                            [rotate]="true"
                            size="sm">
                        </ngb-pagination>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leyenda informativa -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="text-primary mb-3">
                    <i class="fa fa-info-circle"></i> Estructura del Plan de Cuentas
                </h6>
                <div class="row text-sm">
                    <div class="col text-center">
                        <i class="fa fa-coins text-success fa-2x mb-2"></i><br>
                        <strong>Activos</strong><br>
                        <small class="text-muted">Recursos y bienes</small>
                    </div>
                    <div class="col text-center">
                        <i class="fa fa-credit-card text-danger fa-2x mb-2"></i><br>
                        <strong>Pasivos</strong><br>
                        <small class="text-muted">Deudas y obligaciones</small>
                    </div>
                    <div class="col text-center">
                        <i class="fa fa-user-tie text-primary fa-2x mb-2"></i><br>
                        <strong>Patrimonio</strong><br>
                        <small class="text-muted">Capital propio</small>
                    </div>
                    <div class="col text-center">
                        <i class="fa fa-chart-line text-info fa-2x mb-2"></i><br>
                        <strong>Ingresos</strong><br>
                        <small class="text-muted">Dinero que entra</small>
                    </div>
                    <div class="col text-center">
                        <i class="fa fa-chart-bar text-warning fa-2x mb-2"></i><br>
                        <strong>Gastos</strong><br>
                        <small class="text-muted">Dinero que sale</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>